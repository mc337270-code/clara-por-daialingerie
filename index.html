<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Produtos — Funcional</title>

<!-- ZXing -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
    body { font-family: Arial; background:#fce4ec; padding:20px; }
    .box { max-width:900px; margin:auto; background:white; padding:20px; border-radius:12px; }
    input, button { width:100%; padding:10px; margin:8px 0 14px; border-radius:8px; border:1px solid #bbb; font-size:16px; }
    button { background:#ad1457; color:white; cursor:pointer; font-weight:bold; }
    button:hover { background:#8e0c45; }
    #video { width:180px; border:3px solid #ad1457; border-radius:10px; margin-top:10px; }
    .result-card { padding:12px; border:1px solid #ddd; border-radius:10px; margin-top:10px; background:#fff0f6; }
    .result-card button { width:160px; }
</style>
</head>
<body>

<div class="box">

<h1 style="text-align:center;color:#880e4f;">Cadastro de Produtos</h1>

<h2>Cadastrar / Editar Produto</h2>

<label>Nome</label>
<input id="nome">

<label>Tamanho</label>
<input id="tamanho">

<label>Código</label>
<input id="codigo">

<label>Preço</label>
<input id="preco" type="number" step="0.01">

<button onclick="salvarProduto()">Salvar Produto</button>


<hr>

<h2>Buscar Produto</h2>
<input id="busca" onkeyup="buscarProduto()" placeholder="Nome ou código...">

<div style="text-align:center;">
    <video id="video" autoplay muted></video><br>
    <button onclick="startZXing()">Ativar Scanner</button>
</div>

<h3>Resultados</h3>
<div id="resultado"></div>

</div>

<script>
/* Banco de produtos */
let lista = JSON.parse(localStorage.getItem("produtos_v2") || "[]");

/* Inputs */
const inputNome = document.getElementById("nome");
const inputTam = document.getElementById("tamanho");
const inputCod = document.getElementById("codigo");
const inputPreco = document.getElementById("preco");
const inputBusca = document.getElementById("busca");

/* Vídeo */
let video = document.getElementById("video");

/* Scanner */
let codeReader = new ZXing.BrowserMultiFormatReader();
let scanning = false;

/* Salvar Produto */
function salvarProduto(){
    let nome = inputNome.value.trim();
    let tamanho = inputTam.value.trim();
    let codigo = inputCod.value.trim();
    let preco = inputPreco.value.trim();

    if(!nome || !codigo){
        alert("Nome e código são obrigatórios.");
        return;
    }

    let existente = lista.find(p => p.codigo === codigo);

    if(existente){
        existente.nome = nome;
        existente.tamanho = tamanho;
        existente.preco = preco;
    } else {
        lista.push({nome, tamanho, codigo, preco});
    }

    localStorage.setItem("produtos_v2", JSON.stringify(lista));
    alert("Produto salvo com sucesso!");

    buscarProduto();
}

/* Buscar */
function buscarProduto(){
    let termo = inputBusca.value.toLowerCase();

    let filtrados = lista.filter(p =>
        p.nome.toLowerCase().includes(termo) ||
        p.codigo.includes(termo)
    );

    render(filtrados);
}

/* Mostrar resultados */
function render(arr){
    const div = document.getElementById("resultado");
    div.innerHTML = "";

    if(arr.length === 0){
        div.innerHTML = "Nenhum produto encontrado.";
        return;
    }

    arr.forEach(p=>{
        div.innerHTML += `
            <div class="result-card">
                <strong>${p.nome}</strong><br>
                Tamanho: ${p.tamanho}<br>
                Código: ${p.codigo}<br>
                Preço: R$ ${p.preco}<br><br>
                <button onclick="carregar('${p.codigo}')">Carregar</button>
            </div>
        `;
    });
}

function carregar(codigo){
    let p = lista.find(x=>x.codigo === codigo);
    if(!p) return;

    inputNome.value = p.nome;
    inputTam.value = p.tamanho;
    inputCod.value = p.codigo;
    inputPreco.value = p.preco;
}

/* Scanner ZXing — corrigido e eficiente */
async function startZXing(){
    if(scanning) return;
    scanning = true;

    try{
        const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
        if(devices.length === 0){
            alert("Nenhuma câmera encontrada.");
            return;
        }

        const camId = devices[0].deviceId;

        await codeReader.decodeFromVideoDevice(camId, 'video', (result, err) => {
            if(result){
                let code = result.text;
                inputBusca.value = code;
                buscarProduto();

                codeReader.reset(); // PARA DE LER!
                scanning = false;
            }
        });

    } catch(e){
        alert("Erro ao iniciar o scanner.");
        scanning = false;
    }
}

</script>

</body>
</html>
